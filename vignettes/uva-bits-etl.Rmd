---
title: "UvA-BiTS ETL"
author: "Bart Aelterman <bart.aelterman@inbo.be>"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  \usepackage[utf8]{inputenc}
---

# UvA-BiTS ETL

## Intro

At the [Research Institute for Nature and Forest](http://www.inbo.be) (INBO) we are tracking birds using the [UvA-BiTS system](http://www.uva-bits.nl/) as part of the [LifeWatch project](http://www.lifewatch.inbo.be). As tracking data volume grows quicker than human observation data (what we usually work with), we were in need for a data store that contains the cleaned and enriched tracking data in a system that is optimized for querying these *large-ish* data sets. Something like a data warehouse. This R package contains code to extract the data from the UvA-BiTS virtual lab, clean and enrich it, and load it in the data warehouse.

## How to use this package?

Install the package and load it in your R environment.

Read the data files:

```
birds <- load_bird_file("birds_filename")
tracks <- load_tracks_file("tracks_filename")
corine <- read_raster_data("corine_filename")
proj4string(corine) <- CRS("+init=epsg:3035")
```

Validate the data (for documentation, see the section [Extracting and
validating input data](#extracting-and-validating-input-data) below):

```
birds <- validate_bird_data(birds)
tracks <- validate_tracks_data(tracks)
```

Enrich the data (see the section [Enriching the data](#enriching-the-data) below)

```
dt <- enrich_data(tracks, birds, corine)
```

Load the data in a PostgreSQL database. Make sure a database exists. A table `tracking_warehouse` will be created.

```
drv <- dbDriver("PostgreSQL")
con <- dbConnect(drv, dbname="bird_tracking", host="localhost")
data2table(con, dt)
```

To add indexes to the table, perform the `CREATE INDEX` statements in [this file](https://github.com/LifeWatchINBO/uva-bits-etl/blob/master/sql/create_wh_table).

## ETL procedure

### Extracting and validating input data

The data is loaded from csv files. The following input files are expected:

#### Birds metadata

Contains information about the tracked individuals. At the INBO, this file is managed on Google Drive and it is documented [here](https://github.com/LifeWatchINBO/bird-tracking/tree/master/cartodb#bird_tracking-table).

The extraction procedure reads the bird metadata file and verifies whether all columns have the expected data types. Missing values are allowed, but values with an incorrect data type will cause the extraction to halt.

The columns `sex` and `species` are only allowed to have values defined in the package data elements `sex_choices` and `species_choices`.

#### Tracking data

The tracking data is a dump from the UvA-BiTS virtual lab in csv format. It contains the following columns:

| field name | type | description |
| ---------- | ---- | ----------- |
| device_info_serial | number | ID of the GPS tracker |
| date_time | text | Date and time in format "yyyy-mm-dd hh:mm:ss" |
| latitude | number | latitude in WGS84 |
| longitude | number | longitude in WGS84 |
| altitude | number | Altitude in meters above sea level recorded by the GPS tracker |
| pressure | number | air pressure in ??? |
| temperature | number | Temperature recorded by the GPS tracker in degrees Celsius |
| satellites_used | number | Number of satellites used to get a GPS fix |
| gps_fixtime | number | Time to get a GPS fix in seconds |
| positiondop | number | ??? |
| h_accuracy | number | Horizontal accuracy in meters |
| v_accuracy | number | Vertical accuracy in meters |
| x_speed | number | speed in the x dimension measured by the accelerometer in meters per second |
| y_speed | number | speed in the x dimension measured by the accelerometer in meters per second |
| z_speed | number | speed in the x dimension measured by the accelerometer in meters per second |
| speed_accuracy | number | accuracy of the speed measurement in ??? |
| location | text | ??? |
| userflag | number | ??? |
| speed_3d | number | ??? |
| speed_2d | number | ??? |
| direction | number | Heading in degrees (0 is north, 90 is east). |
| altitude_agl | number | ??? |

### Enriching the data

#### 1. Drop unused columns

This is actually already done while extracting the data. The `location` column is deleted from the tracking data.

#### 2. Join bird tracks with bird metadata

Based on the `device_info_serial` field, the bird metadata is attached to every tracking record. If a record in the tracking data is fond for which no bird record exists, the procedure stops. On the other hand, birds that have no tracking records are ignored.

#### 3. Delete test records

Records are deleted if the `date_time` recorded by the tracker is before the `tracking_started_at` of the bird.

#### 4. Calculate time_since_previous_fix

For every bird, the time since the previous GPS fix is calculated. The first fix of every bird gets a value `NA`. The output field is called `inbo_time_diff` and is stored in seconds.

#### 5. Calculate distance travelled

The distance travelled since the last GPS fix is calculated using R's `geosphere` package. The function used is `distCosine` which performs a great circle distance computation. This new field is called `inbo_distance_diff` and is expressed in meters.

#### 6. Calculate speed

Based on the calculated `inbo_time_diff` and `inbo_distance_diff` fields, the two dimensional speed of the bird is calculated in meters per second. The new field is called `inbo_speed_2d`. 

#### 7. Calculate distance to colony

Based on the `colony_latitude` and `colony_longitude`, the distance from the GPS to the colony is computed using `geosphere`'s `distCosine` function. The new field is called `inbo_dist_to_colony` and the distance is stored in meters.

#### 8. Flag outliers

If a record:

* has a `date_time` that is in the future
* has a `altitude` higher than 10.000m (10km)
* has a `inbo_speed_2d` higher than 33.333 m/s (~120km/h) or below 0.
* has a horizontal accuracy (`h_accuracy`) higher than 1000m

it is flagged as outlier. This means that the new `outlier` field is set to `TRUE`.

#### 9. Link with Corine land use

To investigate the habitat use, the [Corine land cover](http://www.eea.europa.eu/data-and-maps/data/corine-land-cover-2006-raster-3) category is matched with the birds position.

## CartoDB procedure

This ETL procedure replaces the previous import procedure used for loading into CartoDB. That procedure is documented at [github](https://github.com/LifeWatchINBO/bird-tracking/blob/master/cartodb/import-procedure.md). However, the following steps of the CartoDB import procedure are not covered by the current ETL procedure:

> <p>9. Optionally, check tracking days to discover birds with relatively low number of tracking days (could indicate bird is dead)</p>


